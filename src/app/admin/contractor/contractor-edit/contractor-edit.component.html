<form [formGroup]="contractorForm">
  <div class="form-container">
    <div class="form-header">
      <h1 class="form-title" *ngIf="isEdit">Edit Contractor Profile</h1>
      <h1 class="form-title" *ngIf="!isEdit">Add New Contractor</h1>
      <p class="form-subtitle" *ngIf="!isEdit">Create a new contractor profile with business details and expertise</p>
      <p class="form-subtitle" *ngIf="isEdit">Update contractor information and qualifications</p>
    </div>

    <div class="form-content">
      <!-- User Selection Section -->
      <div class="section-group">
        <h2 class="section-title">User & Profile Information</h2>
        <ion-row>
          <ion-col>
            <div class="form-group" *ngIf="!isEdit">
              <label class="form-label">Select User *</label>
              <input [formControl]="myControl" type="text" class="search-user" placeholder="Search user by name..." matInput
                [matAutocomplete]="auto">
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn">
                @for (option of filteredContractors | async; track option) {
                <mat-option [value]="option">{{option.firstName}} {{option.lastName}}</mat-option>
                }
              </mat-autocomplete>
              <div class="error-message" *ngIf="myControl?.invalid && (myControl?.dirty || myControl.touched)">
                <div *ngIf="myControl?.errors?.required">User selection is required.</div>
              </div>
            </div>
            <div class="form-group" *ngIf="isEdit">
              <label class="form-label">Assigned User</label>
              <div class="readonly-field">{{contractorDetails?.userId?.firstName}} {{contractorDetails?.userId?.lastName}}</div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">LinkedIn Profile *</label>
              <ion-input formControlName="linkedInProfile" type="text" fill="outline"></ion-input>
              <div class="error-message" *ngIf="contractorForm.controls['linkedInProfile']?.invalid && (contractorForm.controls['linkedInProfile']?.dirty || contractorForm.controls['linkedInProfile'].touched)">
                <div *ngIf="contractorForm.controls['linkedInProfile']?.errors?.required">LinkedIn Profile is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </div>

      <!-- Business Information Section -->
      <div class="section-group">
        <h2 class="section-title">Business Information</h2>
        <div class="form-group">
          <label class="form-label">Business Number *</label>
          <ion-input formControlName="businessNumber" type="number" placeholder="Enter business number" fill="outline"></ion-input>
          <div class="error-message" *ngIf="contractorForm.controls['businessNumber']?.invalid && (contractorForm.controls['businessNumber']?.dirty || contractorForm.controls['businessNumber'].touched)">
            <div *ngIf="contractorForm.controls['businessNumber']?.errors?.required">Business Number is required.</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Business Address Line 1 *</label>
          <ion-input formControlName="businessAddressLine1" type="text" placeholder="Street address" fill="outline"></ion-input>
          <div class="error-message" *ngIf="contractorForm.controls['businessAddressLine1']?.invalid && (contractorForm.controls['businessAddressLine1']?.dirty || contractorForm.controls['businessAddressLine1'].touched)">
            <div *ngIf="contractorForm.controls['businessAddressLine1']?.errors?.required">Business Address is required.</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Business Address Line 2</label>
          <ion-input formControlName="businessAddressLine2" type="text" placeholder="Apt, suite, etc. (optional)" fill="outline"></ion-input>
        </div>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Province *</label>
              <ion-select (ionChange)="handleChangeForProvince($event)" fill="outline"
                formControlName="businessProvinceId" interface="popover" placeholder="Select province...">
                <ion-select-option *ngFor="let item of allProvinces"
                  [value]="item._id">{{item.provinceName}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['businessProvinceId']?.invalid && (contractorForm.controls['businessProvinceId']?.dirty || contractorForm.controls['businessProvinceId'].touched)">
                <div *ngIf="contractorForm.controls['businessProvinceId']?.errors?.required">Province is required.</div>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">City *</label>
              <ion-select fill="outline" formControlName="businessCityId" interface="popover" placeholder="Select city...">
                <ion-select-option *ngFor="let item of allCities"
                  [value]="item._id">{{item.cityName}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['businessCityId']?.invalid && (contractorForm.controls['businessCityId']?.dirty || contractorForm.controls['businessCityId'].touched)">
                <div *ngIf="contractorForm.controls['businessCityId']?.errors?.required">City is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Business Zipcode *</label>
              <ion-input formControlName="businessZipCode" type="text" placeholder="Enter zipcode" fill="outline"></ion-input>
              <div class="error-message" *ngIf="contractorForm.controls['businessZipCode']?.invalid && (contractorForm.controls['businessZipCode']?.dirty || contractorForm.controls['businessZipCode'].touched)">
                <div *ngIf="contractorForm.controls['businessZipCode']?.errors?.required">Business Zipcode is required.</div>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Position *</label>
              <ion-select fill="outline" (ionChange)="handleChangeForPosition($event)" formControlName="position"
                interface="popover" placeholder="Select position...">
                <ion-select-option *ngFor="let item of allPositions"
                  [value]="item._id">{{item.positionName}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['position']?.invalid && (contractorForm.controls['position']?.dirty || contractorForm.controls['position'].touched)">
                <div *ngIf="contractorForm.controls['position']?.errors?.required">Position is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </div>

      <!-- Work Location Section -->
      <div class="section-group">
        <h2 class="section-title">Work Locations & Preferences</h2>
        <div class="form-group">
          <label class="form-label">Work Location Types *</label>
          <ion-select formControlName="location" (ionChange)="handleChange($event)" interface="popover"
            fill="outline" placeholder="Select all applicable locations" [multiple]="true"
            [compareWith]="compareLocationObjects">
            <ion-select-option *ngFor="let item of allLocations" [value]="item">{{item.type}}</ion-select-option>
          </ion-select>
        </div>
        <div class="form-group" *ngIf="hybridSelected">
          <label class="form-label">Office Days per Week (Hybrid)</label>
          <ion-input [formControl]="hybridDays" type="number" placeholder="Number of days" fill="outline"></ion-input>
        </div>
      </div>

      <!-- Expertise Section -->
      <div class="section-group">
        <h2 class="section-title">Professional Expertise</h2>
        <div class="form-group">
          <label class="form-label">Industries (Select up to 3) *</label>
          <ion-searchbar class="searchbar-style" search-icon="search-circle"
            show-clear-button="always" placeholder="Search industries..." type="text"
            debounce="100" (ionInput)="getIndustries($event)"></ion-searchbar>
          <ion-list *ngIf="isIndustryAvailable" class="suggestions-list">
            <ion-item class="suggestion-item" *ngFor="let item of filteredIndustries"
              (click)="onIndustrySelected(item)">
              {{item?.industryName}}</ion-item>
          </ion-list>
          <div class="chips-container">
            <ion-chip *ngFor="let item of selectedIndustries" class="chip-item">
              <ion-label>{{item.industryName}}</ion-label>
              <ion-icon name="close-circle" (click)="onIndustrySelectedRemoved(item)"></ion-icon>
            </ion-chip>
          </div>
          <div *ngIf="industrySelectionErrorMessage" class="error-message">
            {{industrySelectionErrorMessage}}
          </div>
        </div>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Technologies (Select up to 3) *</label>
              <ion-searchbar class="searchbar-style" search-icon="search-circle"
                show-clear-button="always" placeholder="Search technologies..." type="text"
                debounce="100" (ionInput)="getTechnologies($event)"></ion-searchbar>
              <ion-list *ngIf="isTechnologyAvailable" class="suggestions-list">
                <ion-item class="suggestion-item" *ngFor="let item of filteredTechnologies"
                  (click)="onTechnologySelected(item)">
                  {{item?.technologyName}}</ion-item>
              </ion-list>
              <div class="chips-container">
                <ion-chip *ngFor="let item of selectedTechnologies" class="chip-item">
                  <ion-label>{{item.technologyName}}</ion-label>
                  <ion-icon name="close-circle" (click)="onTechnologySelectedRemoved(item)"></ion-icon>
                </ion-chip>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Certifications (Select up to 3) *</label>
              <ion-searchbar class="searchbar-style" search-icon="search-circle"
                show-clear-button="always" placeholder="Search certifications..." type="text"
                debounce="100" (ionInput)="getCertifications($event)"></ion-searchbar>
              <ion-list *ngIf="isCertificationAvailable" class="suggestions-list">
                <ion-item class="suggestion-item" *ngFor="let item of filteredCertifications"
                  (click)="onCertificationSelected(item)">
                  {{item?.certificationName}}</ion-item>
              </ion-list>
              <div class="chips-container">
                <ion-chip *ngFor="let item of selectedCertifications" class="chip-item">
                  <ion-label>{{item.certificationName}}</ion-label>
                  <ion-icon name="close-circle" (click)="onCertificationSelectedRemoved(item)"></ion-icon>
                </ion-chip>
              </div>
              <div *ngIf="certificationSelectionErrorMessage" class="error-message">
                {{certificationSelectionErrorMessage}}
              </div>
            </div>
          </ion-col>
        </ion-row>
      </div>

      <!-- Experience & Compensation Section -->
      <div class="section-group">
        <h2 class="section-title">Experience & Compensation</h2>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Years of Experience *</label>
              <ion-input formControlName="yearsOfExperience" type="number" placeholder="Number of years" fill="outline"></ion-input>
              <div class="error-message" *ngIf="contractorForm.controls['yearsOfExperience']?.invalid && (contractorForm.controls['yearsOfExperience']?.dirty || contractorForm.controls['yearsOfExperience'].touched)">
                <div *ngIf="contractorForm.controls['yearsOfExperience']?.errors?.required">Experience is required.</div>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Hourly Rate (CAD) *</label>
              <ion-input formControlName="hourlyRate" type="number" placeholder="Enter hourly rate" fill="outline"></ion-input>
              <div class="error-message" *ngIf="contractorForm.controls['hourlyRate']?.invalid && (contractorForm.controls['hourlyRate']?.dirty || contractorForm.controls['hourlyRate'].touched)">
                <div *ngIf="contractorForm.controls['hourlyRate']?.errors?.required">Hourly Rate is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </div>

      <!-- Project Preferences Section -->
      <div class="section-group">
        <h2 class="section-title">Project Preferences</h2>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Project Budget *</label>
              <ion-select formControlName="projectBudget" interface="popover" fill="outline"
                placeholder="Select budget ranges..." [multiple]="true">
                <ion-select-option *ngFor="let item of projectBudget" [value]="item">{{item}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['projectBudget']?.invalid && (contractorForm.controls['projectBudget']?.dirty || contractorForm.controls['projectBudget'].touched)">
                <div *ngIf="contractorForm.controls['projectBudget']?.errors?.required">Project Budget selection is required.</div>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Team Size *</label>
              <ion-select formControlName="teamSize" interface="popover" fill="outline"
                placeholder="Select team sizes..." [multiple]="true">
                <ion-select-option *ngFor="let item of teamSize" [value]="item">{{item}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['teamSize']?.invalid && (contractorForm.controls['teamSize']?.dirty || contractorForm.controls['teamSize'].touched)">
                <div *ngIf="contractorForm.controls['teamSize']?.errors?.required">Team Size selection is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Contract Length *</label>
              <ion-select formControlName="contractLength" interface="popover" fill="outline"
                placeholder="Select contract lengths..." [multiple]="true">
                <ion-select-option *ngFor="let item of contractLength" [value]="item">{{item}}</ion-select-option>
              </ion-select>
              <div class="error-message" *ngIf="contractorForm.controls['contractLength']?.invalid && (contractorForm.controls['contractLength']?.dirty || contractorForm.controls['contractLength'].touched)">
                <div *ngIf="contractorForm.controls['contractLength']?.errors?.required">Contract Length selection is required.</div>
              </div>
            </div>
          </ion-col>
          <ion-col>
            <div class="form-group">
              <label class="form-label">Available Start Date *</label>
              <mat-form-field class="date-field">
                <mat-label>Select date</mat-label>
                <input formControlName="availableDate" [min]="todayDate" matInput [matDatepicker]="picker">
                <mat-hint>MM/DD/YYYY</mat-hint>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker disabled="false"></mat-datepicker>
              </mat-form-field>
              <div class="error-message" *ngIf="contractorForm.controls['availableDate']?.invalid && (contractorForm.controls['availableDate']?.dirty || contractorForm.controls['availableDate'].touched)">
                <div *ngIf="contractorForm.controls['availableDate']?.errors?.required">Available Date is required.</div>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </div>

      <!-- Additional Settings -->
      <div class="section-group">
        <div class="form-group checkbox-group">
          <ion-checkbox formControlName="isActive" justify="start">
            <span class="checkbox-label">Mark as Active</span>
          </ion-checkbox>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <ion-button fill="outline" (click)="onBack()" class="btn-secondary" [disabled]="loading">Cancel</ion-button>
      <ion-button (click)="onSave()" class="btn-primary" [disabled]="loading">
        <span *ngIf="!loading">Save Changes</span>
        <span *ngIf="loading">
          <ion-spinner name="crescent" color="light"></ion-spinner>
        </span>
      </ion-button>
    </div>

    <!-- Loading Overlay -->
    <div class="loader-overlay" *ngIf="loading">
      <div class="loader-content">
        <ion-spinner name="circles" color="primary"></ion-spinner>
        <p class="loader-text">Saving contractor details...</p>
      </div>
    </div>
  </div>
</form>
